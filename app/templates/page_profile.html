{% extends "base.html" %}

{% block title %}{{ name|default(handle) }} | JustPros{% endblock %}
{% block og_title %}{{ name|default(handle) }} on JustPros{% endblock %}
{% block og_description %}{{ headline|default('Page on JustPros') }}{% endblock %}
{% if og_image %}{% block og_image %}{{ og_image }}{% endblock %}{% endif %}

{% block content %}
<div class="sm:mt-2 w-full">
    <div class="bg-white sm:rounded-lg shadow overflow-hidden">
        <!-- Cover Image -->
        <div id="cover-container" class="relative group">
            <div id="cover-image" class="h-48 bg-gradient-to-r from-brand-blue to-brand-pink bg-cover bg-center"></div>
            <!-- Editor: Edit overlay for cover -->
            <div id="cover-edit-overlay" class="hidden absolute inset-0 bg-black bg-opacity-0 sm:group-hover:bg-opacity-30 transition-all">
                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 touch-show transition-opacity">
                    <input type="file" id="cover-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                    <button onclick="document.getElementById('cover-input').click()" class="p-2 bg-white rounded-full shadow hover:bg-gray-100" title="Change cover">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                    <button id="cover-delete-btn" onclick="deleteCover()" class="hidden p-2 bg-white rounded-full shadow hover:bg-red-50" title="Delete cover">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="cover-message" class="absolute bottom-2 left-2 text-sm"></div>
        </div>

        <!-- Profile Header -->
        <div class="relative px-6 pb-6">
            <!-- Icon -->
            <div id="icon-container" class="absolute -top-16 left-6 group">
                <img id="page-icon" src="/static/placeholder.svg" alt=""
                     class="w-32 h-32 rounded-lg object-cover border-4 border-white shadow-lg bg-gray-200">
                <!-- Editor: Edit overlay for icon -->
                <div id="icon-edit-overlay" class="hidden absolute inset-0 rounded-lg bg-black bg-opacity-0 sm:group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                    <input type="file" id="icon-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                    <button onclick="document.getElementById('icon-input').click()" class="opacity-0 group-hover:opacity-100 touch-show transition-opacity p-2 bg-white rounded-full shadow hover:bg-gray-100" title="Change icon">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
                <button id="icon-delete-btn" onclick="deleteIcon()" class="hidden absolute -bottom-1 -right-1 p-1.5 bg-white rounded-full shadow border border-gray-200 hover:bg-red-50" title="Delete icon">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <div id="icon-message" class="absolute -bottom-6 left-0 text-xs whitespace-nowrap"></div>
            </div>

            <!-- Profile Info -->
            <div class="pt-20">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <!-- Name display/edit -->
                        <div id="name-display" class="group flex items-center gap-2">
                            <h1 id="page-name" class="text-2xl font-bold text-gray-900">{{ name|default(handle) }}</h1>
                            <button id="name-edit-btn" onclick="startEditing('name')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit name">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="name-edit-form" class="hidden">
                            <div class="flex flex-wrap gap-2 items-center">
                                <input type="text" id="edit-name" placeholder="Page name" maxlength="100" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-64">
                                <button onclick="saveName()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                                <button onclick="cancelEditing('name')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                            </div>
                            <p id="name-error" class="text-red-600 text-sm mt-1 hidden"></p>
                        </div>

                        <!-- Kind display/edit -->
                        <div id="kind-display" class="group flex items-center gap-2 mt-1">
                            <p id="page-kind" class="text-gray-500"></p>
                            <button id="kind-edit-btn" onclick="startEditing('kind')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit type">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="kind-edit-form" class="hidden mt-1">
                            <div class="flex flex-wrap gap-2 items-center">
                                <select id="edit-kind" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue">
                                    <option value="company">Company</option>
                                    <option value="event">Event</option>
                                    <option value="product">Product / Service</option>
                                    <option value="community">Community</option>
                                    <option value="virtual">Virtual Persona</option>
                                </select>
                                <button onclick="saveKind()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                                <button onclick="cancelEditing('kind')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                            </div>
                            <p id="kind-error" class="text-red-600 text-sm mt-1 hidden"></p>
                        </div>

                        <!-- Headline display/edit -->
                        <div id="headline-display" class="group flex items-center gap-2 mt-1">
                            <p id="page-headline" class="text-gray-600">{{ headline }}</p>
                            <button id="headline-edit-btn" onclick="startEditing('headline')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit headline">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="headline-edit-form" class="hidden mt-1">
                            <div class="flex flex-wrap gap-2 items-center">
                                <input type="text" id="edit-headline" placeholder="A short description" maxlength="200" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-64">
                                <button onclick="saveHeadline()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                                <button onclick="cancelEditing('headline')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                            </div>
                            <p id="headline-error" class="text-red-600 text-sm mt-1 hidden"></p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div id="action-buttons" class="flex gap-2 flex-shrink-0">
                        <a id="create-post-btn" href="/?post_as={{ handle }}" class="hidden px-4 py-2 bg-brand-blue text-white rounded-md text-sm font-medium hover:opacity-90">
                            Create Post
                        </a>
                        <button id="follow-btn" onclick="toggleFollow()" class="hidden px-4 py-2 bg-brand-blue text-white rounded-md text-sm font-medium hover:opacity-90">
                            Follow
                        </button>
                        <a id="manage-btn" href="/p/{{ handle }}/editors" class="hidden px-4 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">
                            Manage Editors
                        </a>
                    </div>
                </div>

                <!-- Stats -->
                <div id="page-stats" class="mt-4 text-sm text-gray-500">
                    <span><strong id="follower-count">0</strong> followers</span>
                </div>

                <!-- Description display/edit -->
                <div id="description-display" class="group mt-4">
                    <div class="flex items-start gap-2">
                        <p id="page-description" class="text-gray-600 whitespace-pre-wrap flex-1"></p>
                        <button id="description-edit-btn" onclick="startEditing('description')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity flex-shrink-0" title="Edit description">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                    </div>
                    <p id="description-placeholder" class="hidden text-gray-400 text-sm">No description yet</p>
                </div>
                <div id="description-edit-form" class="hidden mt-4">
                    <textarea id="edit-description" placeholder="Tell people about this page..." rows="4" maxlength="5000" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button onclick="saveDescription()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                        <button onclick="cancelEditing('description')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                    </div>
                    <p id="description-error" class="text-red-600 text-sm mt-1 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Posts -->
    <div class="mt-4">
        <div id="posts-container" class="space-y-4">
            <div id="posts-loading" class="bg-white sm:rounded-lg shadow p-8 text-center text-gray-500">
                Loading posts...
            </div>
        </div>

        <div id="no-posts" class="hidden bg-white sm:rounded-lg shadow p-8 text-center">
            <p class="text-gray-500">No posts yet.</p>
        </div>
    </div>
</div>

<script src="/static/js/posts.js"></script>
<script>
    const pageHandle = '{{ handle }}';
    let pageData = null;
    let status = null;
    let isFollowing = false;
    let editingSection = null;

    const kindLabels = {
        company: 'Company',
        event: 'Event',
        product: 'Product/Service',
        community: 'Community',
        virtual: 'Virtual Persona'
    };

    // Uses shared functions from /static/js/posts.js:
    // - escapeHtml, formatTime, formatPostContent, renderPostMedia, openImageModal, getDefaultPageIcon
    // - renderPost, renderScaleIcon, renderVotePicker, togglePostMenu, closePostMenu, sharePost

    function getDefaultIcon(kind) {
        return getDefaultPageIcon(kind);
    }

    // State for voting and comments (used by shared renderPost)
    let currentUserVotes = {};
    let expandedPosts = new Set();
    let loadedComments = {};

    async function loadPageData() {
        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}`);
            if (!response.ok) {
                document.getElementById('posts-loading').textContent = 'Page not found';
                return;
            }

            pageData = await response.json();

            // Update UI
            document.getElementById('page-name').textContent = pageData.name;
            document.getElementById('page-kind').textContent = kindLabels[pageData.kind] || 'Page';

            if (pageData.headline) {
                document.getElementById('page-headline').textContent = pageData.headline;
            }

            // Set icon - use custom or default based on kind
            document.getElementById('page-icon').src = pageData.icon_url || getDefaultIcon(pageData.kind);

            if (pageData.cover_url) {
                document.getElementById('cover-image').style.backgroundImage = `url(${pageData.cover_url})`;
            }

            if (pageData.description) {
                document.getElementById('page-description').textContent = pageData.description;
            } else {
                document.getElementById('page-description').classList.add('hidden');
            }

            document.getElementById('follower-count').textContent = pageData.follower_count || 0;

            // Load status and posts
            await Promise.all([loadStatus(), loadPosts()]);
        } catch (e) {
            console.error('Failed to load page:', e);
            document.getElementById('posts-loading').textContent = 'Failed to load page';
        }
    }

    async function loadStatus() {
        const token = localStorage.getItem('token');
        if (!token) {
            document.getElementById('follow-btn').classList.remove('hidden');
            document.getElementById('follow-btn').onclick = () => window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/status`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                console.error('Failed to load status:', response.status);
                return;
            }

            status = await response.json();
            isFollowing = status.is_following;

            // Show appropriate buttons
            const followBtn = document.getElementById('follow-btn');
            const manageBtn = document.getElementById('manage-btn');

            if (status.is_editor) {
                manageBtn.classList.remove('hidden');
                showEditorControls();
            }

            if (!status.is_owner) {
                followBtn.classList.remove('hidden');
                updateFollowButton();
            }
        } catch (e) {
            console.error('Failed to load status:', e);
        }
    }

    function showEditorControls() {
        // Show create post button
        document.getElementById('create-post-btn').classList.remove('hidden');

        // Show edit overlays for images
        document.getElementById('cover-edit-overlay').classList.remove('hidden');
        document.getElementById('icon-edit-overlay').classList.remove('hidden');

        // Show edit buttons
        document.getElementById('name-edit-btn').classList.remove('hidden');
        document.getElementById('kind-edit-btn').classList.remove('hidden');
        document.getElementById('headline-edit-btn').classList.remove('hidden');
        document.getElementById('description-edit-btn').classList.remove('hidden');

        // Show delete buttons if images exist
        if (pageData.cover_url) {
            document.getElementById('cover-delete-btn').classList.remove('hidden');
        }
        if (pageData.icon_url) {
            document.getElementById('icon-delete-btn').classList.remove('hidden');
        }

        // Show description placeholder if empty
        if (!pageData.description) {
            document.getElementById('description-placeholder').classList.remove('hidden');
        }
    }

    function updateFollowButton() {
        const btn = document.getElementById('follow-btn');
        if (isFollowing) {
            btn.textContent = 'Following';
            btn.className = 'px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm';
        } else {
            btn.textContent = 'Follow';
            btn.className = 'px-4 py-2 bg-brand-blue text-white rounded-md hover:opacity-90 text-sm';
        }
    }

    async function toggleFollow() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        const btn = document.getElementById('follow-btn');
        btn.disabled = true;

        try {
            const method = isFollowing ? 'DELETE' : 'POST';
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/follow`, {
                method,
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                isFollowing = !isFollowing;
                updateFollowButton();

                // Update follower count
                const countEl = document.getElementById('follower-count');
                const count = parseInt(countEl.textContent) + (isFollowing ? 1 : -1);
                countEl.textContent = Math.max(0, count);
            }
        } catch (e) {
            console.error('Failed to toggle follow:', e);
        } finally {
            btn.disabled = false;
        }
    }

    async function loadPosts() {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

        try {
            const response = await fetch(`/api/posts?page=${encodeURIComponent(pageHandle)}`, { headers });
            if (!response.ok) {
                console.error('Failed to load posts:', response.status);
                return;
            }

            const data = await response.json();
            const container = document.getElementById('posts-container');

            if (data.posts.length === 0) {
                container.innerHTML = '';
                document.getElementById('no-posts').classList.remove('hidden');
                return;
            }

            document.getElementById('no-posts').classList.add('hidden');
            container.innerHTML = data.posts.map(post => renderPost(post, { currentUserVotes })).join('');
        } catch (e) {
            console.error('Failed to load posts:', e);
        }
    }

    // --- Simple Voting System (handlers for shared renderPost) ---

    async function submitVote(postId, value, event) {
        event.stopPropagation();

        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            let response;
            if (value === null) {
                // Remove vote via DELETE
                response = await fetch(`/api/posts/${postId}/vote`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            } else {
                // Submit vote via POST
                response = await fetch(`/api/posts/${postId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value })
                });
            }

            if (response.ok) {
                const data = await response.json();
                updateVoteDisplay(postId, data);
            }
        } catch (e) {
            console.error('Failed to vote:', e);
        }
    }

    function updateVoteDisplay(postId, data) {
        currentUserVotes[postId] = data.user_vote;

        // Re-render the vote buttons (user can vote since they just did)
        const container = document.getElementById(`vote-container-${postId}`);
        if (container) {
            container.innerHTML = renderVoteButtons(postId, data.upvote_count, data.downvote_count, data.user_vote, true, 'post');
        }
    }

    // --- Comments System ---

    async function toggleComments(postId) {
        const section = document.getElementById(`comments-section-${postId}`);

        if (expandedPosts.has(postId)) {
            section.classList.add('hidden');
            expandedPosts.delete(postId);
        } else {
            section.classList.remove('hidden');
            expandedPosts.add(postId);

            if (!loadedComments[postId]) {
                section.innerHTML = '<div class="p-4 text-center text-gray-500">Loading...</div>';
                await loadComments(postId);
            } else {
                renderCommentsSection(postId, loadedComments[postId]);
            }
        }
    }

    async function loadComments(postId) {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

        try {
            const response = await fetch(`/api/posts/${postId}`, { headers });
            if (!response.ok) {
                console.error('Failed to load comments');
                return;
            }

            const data = await response.json();
            loadedComments[postId] = data.comments;
            renderCommentsSection(postId, data.comments);
        } catch (e) {
            console.error('Failed to load comments:', e);
        }
    }

    function renderCommentsSection(postId, comments) {
        const section = document.getElementById(`comments-section-${postId}`);
        const token = localStorage.getItem('token');

        let html = '<div class="divide-y divide-gray-100">';

        if (comments.length === 0) {
            html += '<div class="p-4 text-center text-gray-500 text-sm">No comments yet</div>';
        } else {
            comments.forEach(comment => {
                html += renderComment(comment, postId);
            });
        }

        html += '</div>';

        if (token) {
            html += `
                <div class="p-3 border-t border-gray-100">
                    <form onsubmit="submitReply(event, ${postId})" class="flex gap-2">
                        <input type="text" id="reply-input-${postId}" placeholder="Write a comment..." maxlength="2000"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue">
                        <button type="submit" class="px-4 py-2 bg-brand-blue text-white rounded-full hover:opacity-90 text-sm">
                            Reply
                        </button>
                    </form>
                </div>
            `;
        }

        section.innerHTML = html;
    }

    function renderComment(comment, rootPostId) {
        const authorUrl = `/u/${comment.author.handle}`;
        const avatarUrl = comment.author.avatar_url || '/static/default-avatar.svg';
        const timeStr = formatTime(comment.created_at);

        return `
            <div class="p-3 hover:bg-gray-50" id="comment-${comment.id}">
                <div class="flex items-start gap-2">
                    <a href="${authorUrl}" class="flex-shrink-0">
                        <img src="${avatarUrl}" alt="" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                    </a>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap text-sm">
                            <a href="${authorUrl}" class="font-medium text-gray-900 hover:underline">${escapeHtml(comment.author.name || comment.author.handle)}</a>
                            <span class="text-gray-400 text-xs">${timeStr}</span>
                        </div>
                        <p class="text-gray-800 mt-1 whitespace-pre-wrap break-words text-sm">${formatPostContent(comment.content)}</p>
                    </div>
                </div>
            </div>
        `;
    }

    async function submitReply(event, rootPostId) {
        event.preventDefault();

        const input = document.getElementById(`reply-input-${rootPostId}`);
        const content = input.value.trim();
        if (!content) return;

        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch(`/api/posts/${rootPostId}/reply`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            if (response.ok) {
                input.value = '';
                delete loadedComments[rootPostId];
                await loadComments(rootPostId);
                const countEl = document.getElementById(`comment-count-${rootPostId}`);
                if (countEl) {
                    countEl.textContent = parseInt(countEl.textContent) + 1;
                }
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to post comment');
            }
        } catch (e) {
            console.error('Failed to post comment:', e);
            alert('Failed to post comment');
        }
    }

    // --- Report and Delete ---

    async function reportAbuse(postId) {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        if (!confirm('Report this content for abuse? Our team will review it.')) {
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}/report`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert('Report submitted. Thank you for helping keep JustPros clean.');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to submit report');
            }
        } catch (e) {
            console.error('Failed to report:', e);
            alert('Failed to submit report');
        }
    }

    function showDeleteModal(postId) {
        if (confirm('Delete this post? This action cannot be undone.')) {
            deletePost(postId);
        }
    }

    async function deletePost(postId) {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                await loadPosts();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete');
            }
        } catch (e) {
            console.error('Failed to delete:', e);
            alert('Failed to delete');
        }
    }

    // --- Inline Editing ---

    function startEditing(section) {
        if (editingSection && editingSection !== section) {
            cancelEditing(editingSection);
        }
        editingSection = section;

        document.getElementById(`${section}-display`).classList.add('hidden');
        document.getElementById(`${section}-edit-form`).classList.remove('hidden');

        // Pre-fill values
        if (section === 'name') {
            document.getElementById('edit-name').value = pageData.name || '';
            document.getElementById('edit-name').focus();
        } else if (section === 'kind') {
            document.getElementById('edit-kind').value = pageData.kind || 'company';
            document.getElementById('edit-kind').focus();
        } else if (section === 'headline') {
            document.getElementById('edit-headline').value = pageData.headline || '';
            document.getElementById('edit-headline').focus();
        } else if (section === 'description') {
            document.getElementById('edit-description').value = pageData.description || '';
            document.getElementById('edit-description').focus();
        }
    }

    function cancelEditing(section) {
        document.getElementById(`${section}-display`).classList.remove('hidden');
        document.getElementById(`${section}-edit-form`).classList.add('hidden');
        const errorEl = document.getElementById(`${section}-error`);
        if (errorEl) errorEl.classList.add('hidden');
        editingSection = null;
    }

    async function saveName() {
        const token = localStorage.getItem('token');
        const name = document.getElementById('edit-name').value.trim();
        const errorEl = document.getElementById('name-error');

        if (!name) {
            errorEl.textContent = 'Name is required';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            });

            if (response.ok) {
                pageData.name = name;
                document.getElementById('page-name').textContent = name;
                cancelEditing('name');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    async function saveKind() {
        const token = localStorage.getItem('token');
        const kind = document.getElementById('edit-kind').value;
        const errorEl = document.getElementById('kind-error');

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ kind })
            });

            if (response.ok) {
                pageData.kind = kind;
                document.getElementById('page-kind').textContent = kindLabels[kind] || 'Page';
                // Update icon if using default
                if (!pageData.icon_url) {
                    document.getElementById('page-icon').src = getDefaultIcon(kind);
                }
                cancelEditing('kind');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    async function saveHeadline() {
        const token = localStorage.getItem('token');
        const headline = document.getElementById('edit-headline').value.trim();
        const errorEl = document.getElementById('headline-error');

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ headline: headline || null })
            });

            if (response.ok) {
                pageData.headline = headline;
                document.getElementById('page-headline').textContent = headline;
                cancelEditing('headline');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    async function saveDescription() {
        const token = localStorage.getItem('token');
        const description = document.getElementById('edit-description').value.trim();
        const errorEl = document.getElementById('description-error');

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ description: description || null })
            });

            if (response.ok) {
                pageData.description = description;
                const descEl = document.getElementById('page-description');
                const placeholderEl = document.getElementById('description-placeholder');

                if (description) {
                    descEl.textContent = description;
                    descEl.classList.remove('hidden');
                    placeholderEl.classList.add('hidden');
                } else {
                    descEl.textContent = '';
                    descEl.classList.add('hidden');
                    placeholderEl.classList.remove('hidden');
                }
                cancelEditing('description');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    // --- Image Upload ---

    document.getElementById('cover-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            document.getElementById('cover-message').innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">File too large (max 5MB)</span>';
            return;
        }

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('cover-message');
        messageEl.innerHTML = '<span class="text-white bg-black bg-opacity-50 px-2 py-1 rounded">Uploading...</span>';

        try {
            const urlRes = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/cover/upload-url`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_type: file.type })
            });

            if (!urlRes.ok) {
                const data = await urlRes.json();
                messageEl.innerHTML = `<span class="text-red-600 bg-white px-2 py-1 rounded">${data.detail || 'Failed'}</span>`;
                return;
            }

            const { upload_url, media_path } = await urlRes.json();

            const uploadRes = await fetch(upload_url, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });

            if (!uploadRes.ok) {
                messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Upload failed</span>';
                return;
            }

            const confirmRes = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/cover/confirm`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ media_path })
            });

            if (confirmRes.ok) {
                const data = await confirmRes.json();
                document.getElementById('cover-image').style.backgroundImage = `url(${data.cover_url})`;
                pageData.cover_url = data.cover_url;
                document.getElementById('cover-delete-btn').classList.remove('hidden');
                messageEl.innerHTML = '<span class="text-green-600 bg-white px-2 py-1 rounded">Updated!</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
        }
        e.target.value = '';
    });

    document.getElementById('icon-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 2 * 1024 * 1024) {
            document.getElementById('icon-message').innerHTML = '<span class="text-red-600">Too large (max 2MB)</span>';
            return;
        }

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('icon-message');
        messageEl.innerHTML = '<span class="text-gray-500">Uploading...</span>';

        try {
            const urlRes = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/icon/upload-url`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_type: file.type })
            });

            if (!urlRes.ok) {
                const data = await urlRes.json();
                messageEl.innerHTML = `<span class="text-red-600">${data.detail || 'Failed'}</span>`;
                return;
            }

            const { upload_url, media_path } = await urlRes.json();

            const uploadRes = await fetch(upload_url, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });

            if (!uploadRes.ok) {
                messageEl.innerHTML = '<span class="text-red-600">Upload failed</span>';
                return;
            }

            const confirmRes = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/icon/confirm`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ media_path })
            });

            if (confirmRes.ok) {
                const data = await confirmRes.json();
                document.getElementById('page-icon').src = data.icon_url;
                pageData.icon_url = data.icon_url;
                document.getElementById('icon-delete-btn').classList.remove('hidden');
                messageEl.innerHTML = '<span class="text-green-600">Updated!</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
        }
        e.target.value = '';
    });

    async function deleteCover() {
        if (!confirm('Delete the cover image?')) return;

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('cover-message');

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/cover`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                document.getElementById('cover-image').style.backgroundImage = '';
                document.getElementById('cover-image').className = 'h-48 bg-gradient-to-r from-brand-blue to-brand-pink bg-cover bg-center';
                document.getElementById('cover-delete-btn').classList.add('hidden');
                pageData.cover_url = null;
                messageEl.innerHTML = '<span class="text-green-600 bg-white px-2 py-1 rounded">Deleted</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
        }
    }

    async function deleteIcon() {
        if (!confirm('Delete the page icon?')) return;

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('icon-message');

        try {
            const response = await fetch(`/api/pages/${encodeURIComponent(pageHandle)}/icon`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                document.getElementById('page-icon').src = getDefaultIcon(pageData.kind);
                document.getElementById('icon-delete-btn').classList.add('hidden');
                pageData.icon_url = null;
                messageEl.innerHTML = '<span class="text-green-600">Deleted</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
        }
    }

    // Close editing on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && editingSection) {
            cancelEditing(editingSection);
        }
    });

    async function init() {
        await loadPageData();
    }

    init();
</script>
{% endblock %}
