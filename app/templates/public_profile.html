{% extends "base.html" %}
{% block title %}{{ name or handle }} - JustPros{% endblock %}
{% block og_title %}{{ name or handle }} - JustPros{% endblock %}
{% block og_description %}{{ headline or "Professional on JustPros" }}{% endblock %}
{% block og_url %}/u/{{ handle }}{% endblock %}
{% if og_image %}{% block og_image %}{{ og_image }}{% endblock %}{% endif %}
{% block twitter_title %}{{ name or handle }} - JustPros{% endblock %}
{% block twitter_description %}{{ headline or "Professional on JustPros" }}{% endblock %}
{% if og_image %}{% block twitter_image %}{{ og_image }}{% endblock %}{% endif %}
{% block content %}
<div class="mt-2 w-full">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <!-- Cover Image -->
        <div id="cover-image" class="h-48 bg-gray-300 bg-cover bg-center"></div>

        <!-- Profile Header -->
        <div class="relative px-6 pb-6">
            <!-- Avatar overlapping cover -->
            <div class="absolute -top-16 left-6">
                <img id="avatar-image" src="/static/default-avatar.svg" alt="Avatar"
                    class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg bg-white">
            </div>

            <!-- Profile Info -->
            <div class="pt-20">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <h1 id="profile-name" class="text-2xl font-bold text-gray-900"></h1>
                        <p id="profile-headline" class="text-gray-600 mt-1"></p>
                    </div>
                    <button id="connect-btn" class="hidden bg-brand-blue text-white px-4 py-2 rounded-md hover:opacity-90 text-sm font-medium flex-shrink-0">
                        Connect
                    </button>
                </div>

                <!-- Skills -->
                <div id="profile-skills" class="flex flex-wrap gap-2 mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Future: Posts will go here -->
</div>

<script>
    const handle = '{{ handle }}';

    async function loadPublicProfile() {
        try {
            const response = await fetch(`/api/u/${encodeURIComponent(handle)}`);

            if (response.status === 404) {
                document.querySelector('.max-w-2xl').innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <h1 class="text-2xl font-bold text-gray-900 mb-2">User not found</h1>
                        <p class="text-gray-600">The profile you're looking for doesn't exist.</p>
                    </div>
                `;
                return;
            }

            const data = await response.json();

            document.getElementById('profile-name').textContent = data.name || handle;
            document.getElementById('profile-headline').textContent = data.headline || '';

            if (data.avatar_url) {
                document.getElementById('avatar-image').src = data.avatar_url;
            }

            if (data.cover_url) {
                document.getElementById('cover-image').style.backgroundImage = `url(${data.cover_url})`;
            }

            const skillsContainer = document.getElementById('profile-skills');
            if (data.skills && data.skills.length > 0) {
                skillsContainer.innerHTML = data.skills.map(skill =>
                    `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${skill}</span>`
                ).join('');
            }

            // Update page title
            if (data.name) {
                document.title = `${data.name} - JustPros`;
            }

            // Show Connect button if logged in and not viewing own profile
            await showConnectButton();
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    async function showConnectButton() {
        const token = localStorage.getItem('token');
        if (!token) return;

        // Check if token is valid
        const payload = parseJwt(token);
        if (!payload || payload.exp * 1000 <= Date.now()) return;

        // Get current user's handle to check if viewing own profile
        try {
            const response = await fetch('/api/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;

            const me = await response.json();
            // Don't show Connect button on own profile
            if (me.handle === handle) return;

            // Show the Connect button
            document.getElementById('connect-btn').classList.remove('hidden');
        } catch (e) {
            console.error('Failed to check current user:', e);
        }
    }

    loadPublicProfile();
</script>
{% endblock %}
