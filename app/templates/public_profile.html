{% extends "base.html" %}
{% block title %}{{ name or handle }} | JustPros{% endblock %}
{% block og_title %}{{ name or handle }} | JustPros{% endblock %}
{% block og_description %}{{ headline or "Professional on JustPros" }}{% endblock %}
{% block og_url %}/u/{{ handle }}{% endblock %}
{% if og_image %}{% block og_image %}{{ og_image }}{% endblock %}{% endif %}
{% block twitter_title %}{{ name or handle }} | JustPros{% endblock %}
{% block twitter_description %}{{ headline or "Professional on JustPros" }}{% endblock %}
{% if og_image %}{% block twitter_image %}{{ og_image }}{% endblock %}{% endif %}
{% block content %}
<div class="mt-2 w-full">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <!-- Cover Image -->
        <div id="cover-image" class="h-48 bg-gray-300 bg-cover bg-center"></div>

        <!-- Profile Header -->
        <div class="relative px-6 pb-6">
            <!-- Avatar overlapping cover -->
            <div class="absolute -top-16 left-6">
                <img id="avatar-image" src="/static/default-avatar.svg" alt="Avatar"
                    class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg bg-white">
            </div>

            <!-- Profile Info -->
            <div class="pt-20">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <h1 id="profile-name" class="text-2xl font-bold text-gray-900"></h1>
                        <p id="profile-headline" class="text-gray-600 mt-1"></p>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <a id="message-btn" href="#" class="hidden px-4 py-2 border border-brand-blue text-brand-blue rounded-md text-sm font-medium hover:bg-blue-50">
                            Message
                        </a>
                        <button id="connect-btn" class="hidden px-4 py-2 bg-brand-blue text-white rounded-md text-sm font-medium hover:opacity-90">
                            Connect
                        </button>
                    </div>
                </div>

                <!-- Skills -->
                <div id="profile-skills" class="flex flex-wrap gap-2 mt-4"></div>

                <!-- Connection status badge -->
                <div id="connection-status" class="hidden mt-4">
                    <span class="inline-flex items-center gap-1 text-sm text-green-700 bg-green-100 px-3 py-1 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Connected
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Claim Modal -->
<div id="claim-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold">Connect with <span id="modal-name"></span></h2>
                <button onclick="hideClaimModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        <form id="claim-form" class="p-4">
            <div class="mb-4">
                <label id="claim-label" class="block text-sm font-medium text-gray-700 mb-1">Tell them why you should be connected</label>
                <textarea id="claim-content" rows="3" maxlength="500" required
                    placeholder="e.g., We worked together at Acme Corp from 2020-2022"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue resize-none"></textarea>
                <p class="text-xs text-gray-500 mt-1"><span id="claim-chars">0</span>/500 characters</p>
            </div>
            <div id="claim-error" class="hidden text-red-600 text-sm mb-3"></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideClaimModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" id="claim-submit-btn" class="px-4 py-2 bg-brand-blue text-white rounded-md hover:opacity-90 disabled:opacity-50" disabled>
                    Send Request
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Pending Claim Modal (for incoming requests) -->
<div id="pending-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Connection Request</h2>
                <button onclick="hidePendingModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-gray-600 mb-2"><span id="pending-name" class="font-medium"></span> wants to connect:</p>
            <div class="bg-gray-50 p-3 rounded-md mb-4">
                <p id="pending-content" class="text-gray-700 whitespace-pre-wrap"></p>
            </div>
            <div id="pending-error" class="hidden text-red-600 text-sm mb-4"></div>
            <div class="flex gap-3">
                <button onclick="ignorePendingClaim()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Ignore</button>
                <button onclick="confirmPendingClaim()" class="flex-1 px-4 py-2 bg-brand-blue text-white rounded-md hover:opacity-90">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    const handle = '{{ handle }}';
    let profileName = '';
    let conversationState = null;

    function parseJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch {
            return null;
        }
    }

    async function loadPublicProfile() {
        try {
            const response = await fetch(`/api/u/${encodeURIComponent(handle)}`);

            if (response.status === 404) {
                document.querySelector('.mt-2').innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <h1 class="text-2xl font-bold text-gray-900 mb-2">User not found</h1>
                        <p class="text-gray-600">The profile you're looking for doesn't exist.</p>
                    </div>
                `;
                return;
            }

            const data = await response.json();
            profileName = data.name || handle;

            document.getElementById('profile-name').textContent = profileName;
            document.getElementById('profile-headline').textContent = data.headline || '';
            document.getElementById('modal-name').textContent = profileName;
            document.getElementById('pending-name').textContent = profileName;

            if (data.avatar_url) {
                document.getElementById('avatar-image').src = data.avatar_url;
            }

            if (data.cover_url) {
                document.getElementById('cover-image').style.backgroundImage = `url(${data.cover_url})`;
            }

            const skillsContainer = document.getElementById('profile-skills');
            if (data.skills && data.skills.length > 0) {
                skillsContainer.innerHTML = data.skills.map(skill =>
                    `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${skill}</span>`
                ).join('');
            }

            if (data.name) {
                document.title = `${data.name} | JustPros`;
            }

            // Load connection buttons
            await updateButtons();
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    async function updateButtons() {
        const token = localStorage.getItem('token');
        if (!token) return;

        const payload = parseJwt(token);
        if (!payload || payload.exp * 1000 <= Date.now()) return;

        try {
            // Check if viewing own profile
            const meResponse = await fetch('/api/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!meResponse.ok) return;

            const me = await meResponse.json();
            if (me.handle === handle) return; // Own profile

            // Get conversation state
            const response = await fetch(`/api/messages/with/${encodeURIComponent(handle)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;

            conversationState = await response.json();

            const connectBtn = document.getElementById('connect-btn');
            const messageBtn = document.getElementById('message-btn');
            const statusBadge = document.getElementById('connection-status');

            if (conversationState.is_connected) {
                // Connected - show Message button and status badge
                messageBtn.href = `/messages/${handle}`;
                messageBtn.classList.remove('hidden');
                statusBadge.classList.remove('hidden');
                connectBtn.classList.add('hidden');
            } else if (conversationState.pending_request_from_them) {
                // They sent me a request - show Respond button
                connectBtn.textContent = 'Respond';
                connectBtn.onclick = showPendingModal;
                connectBtn.classList.remove('hidden');
            } else if (conversationState.pending_request_from_me) {
                // I sent them a request - show pending status
                connectBtn.textContent = 'Pending...';
                connectBtn.disabled = true;
                connectBtn.className = 'px-4 py-2 bg-gray-100 text-gray-500 rounded-md text-sm font-medium cursor-not-allowed';
                connectBtn.classList.remove('hidden');
            } else {
                // No connection - show Connect button
                connectBtn.textContent = 'Connect';
                connectBtn.onclick = showClaimModal;
                connectBtn.classList.remove('hidden');
            }
        } catch (e) {
            console.error('Failed to check connection status:', e);
        }
    }

    // Claim modal functions
    function showClaimModal() {
        document.getElementById('claim-label').textContent = `Tell ${profileName} why you should be connected`;
        document.getElementById('claim-modal').classList.remove('hidden');
        document.getElementById('claim-content').focus();
    }

    function hideClaimModal() {
        document.getElementById('claim-modal').classList.add('hidden');
        document.getElementById('claim-content').value = '';
        document.getElementById('claim-chars').textContent = '0';
        document.getElementById('claim-error').classList.add('hidden');
        document.getElementById('claim-submit-btn').disabled = true;
    }

    document.getElementById('claim-content').addEventListener('input', (e) => {
        const len = e.target.value.trim().length;
        document.getElementById('claim-chars').textContent = e.target.value.length;
        document.getElementById('claim-submit-btn').disabled = len < 1;
    });

    document.getElementById('claim-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = document.getElementById('claim-content').value.trim();
        if (!content) return;

        const token = localStorage.getItem('token');
        const errorEl = document.getElementById('claim-error');
        const submitBtn = document.getElementById('claim-submit-btn');

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
            const response = await fetch(`/api/messages/to/${encodeURIComponent(handle)}/connect`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to send connection request');
            }

            hideClaimModal();
            // Redirect to messages to see the conversation
            window.location.href = `/messages/${handle}`;
        } catch (e) {
            errorEl.textContent = e.message;
            errorEl.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Request';
        }
    });

    // Pending claim modal functions
    async function showPendingModal() {
        // Load the pending claim content
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/api/messages/with/${encodeURIComponent(handle)}/messages`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;

            const data = await response.json();
            // Find the pending connection request from them
            const pendingRequest = data.messages.find(m => m.kind === 'connection_request' && !m.is_mine);
            if (pendingRequest) {
                document.getElementById('pending-content').textContent = pendingRequest.content;
                document.getElementById('pending-modal').classList.remove('hidden');
            }
        } catch (e) {
            console.error('Failed to load pending claim:', e);
        }
    }

    function hidePendingModal() {
        document.getElementById('pending-modal').classList.add('hidden');
        document.getElementById('pending-error').classList.add('hidden');
    }

    async function confirmPendingClaim() {
        const token = localStorage.getItem('token');
        const errorEl = document.getElementById('pending-error');

        try {
            const response = await fetch(`/api/messages/to/${encodeURIComponent(handle)}/confirm`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to confirm connection');
            }

            hidePendingModal();
            await updateButtons();
        } catch (e) {
            errorEl.textContent = e.message;
            errorEl.classList.remove('hidden');
        }
    }

    async function ignorePendingClaim() {
        const token = localStorage.getItem('token');
        const errorEl = document.getElementById('pending-error');

        try {
            const response = await fetch(`/api/messages/with/${encodeURIComponent(handle)}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to ignore connection');
            }

            hidePendingModal();
            await updateButtons();
        } catch (e) {
            errorEl.textContent = e.message;
            errorEl.classList.remove('hidden');
        }
    }

    // Close modals on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideClaimModal();
            hidePendingModal();
        }
    });

    // Close modals on backdrop click
    document.getElementById('claim-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) hideClaimModal();
    });
    document.getElementById('pending-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) hidePendingModal();
    });

    loadPublicProfile();
</script>
{% endblock %}
