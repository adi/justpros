{% extends "base.html" %}
{% block title %}{{ name or handle }} | JustPros{% endblock %}
{% block og_title %}{{ name or handle }} | JustPros{% endblock %}
{% block og_description %}{{ headline or "Professional on JustPros" }}{% endblock %}
{% block og_url %}/u/{{ handle }}{% endblock %}
{% if og_image %}{% block og_image %}{{ og_image }}{% endblock %}{% endif %}
{% block twitter_title %}{{ name or handle }} | JustPros{% endblock %}
{% block twitter_description %}{{ headline or "Professional on JustPros" }}{% endblock %}
{% if og_image %}{% block twitter_image %}{{ og_image }}{% endblock %}{% endif %}
{% block content %}
<div class="sm:mt-2 w-full">
    <div class="bg-white sm:rounded-lg shadow overflow-hidden">
        <!-- Cover Image -->
        <div id="cover-container" class="relative group">
            <div id="cover-image" class="h-48 bg-gray-300 bg-cover bg-center"></div>
            <!-- Owner: Edit overlay for cover -->
            <div id="cover-edit-overlay" class="hidden absolute inset-0 bg-black bg-opacity-0 sm:group-hover:bg-opacity-30 transition-all">
                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 touch-show transition-opacity">
                    <input type="file" id="cover-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                    <button onclick="document.getElementById('cover-input').click()" class="p-2 bg-white rounded-full shadow hover:bg-gray-100" title="Change cover">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                    <button id="cover-delete-btn" onclick="deleteCover()" class="hidden p-2 bg-white rounded-full shadow hover:bg-red-50" title="Delete cover">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="cover-message" class="absolute bottom-2 left-2 text-sm"></div>
        </div>

        <!-- Profile Header -->
        <div class="relative px-6 pb-6">
            <!-- Avatar -->
            <div id="avatar-container" class="absolute -top-16 left-6 group">
                <img id="avatar-image" src="/static/default-avatar.svg" alt="Avatar"
                    class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg bg-white">
                <!-- Owner: Edit overlay for avatar -->
                <div id="avatar-edit-overlay" class="hidden absolute inset-0 rounded-full bg-black bg-opacity-0 sm:group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                    <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                    <button onclick="document.getElementById('avatar-input').click()" class="opacity-0 group-hover:opacity-100 touch-show transition-opacity p-2 bg-white rounded-full shadow hover:bg-gray-100" title="Change photo">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
                <button id="avatar-delete-btn" onclick="deleteAvatar()" class="hidden absolute -bottom-1 -right-1 p-1.5 bg-white rounded-full shadow border border-gray-200 hover:bg-red-50" title="Delete photo">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <div id="avatar-message" class="absolute -bottom-6 left-0 text-xs whitespace-nowrap"></div>
            </div>

            <!-- Profile Info -->
            <div class="pt-20">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <!-- Name display/edit -->
                        <div id="name-display" class="group flex items-center gap-2">
                            <h1 id="profile-name" class="text-2xl font-bold text-gray-900"></h1>
                            <button id="name-edit-btn" onclick="startEditing('name')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit name">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="name-edit-form" class="hidden">
                            <div class="flex flex-wrap gap-2 items-center">
                                <input type="text" id="edit-first-name" placeholder="First name" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-28">
                                <input type="text" id="edit-middle-name" placeholder="Middle" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-24">
                                <input type="text" id="edit-last-name" placeholder="Last name" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-28">
                                <button onclick="saveName()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                                <button onclick="cancelEditing('name')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                            </div>
                            <p id="name-error" class="text-red-600 text-sm mt-1 hidden"></p>
                        </div>

                        <!-- Handle display/edit -->
                        <div id="handle-display" class="group flex items-center gap-2 mt-1">
                            <p id="profile-handle" class="text-gray-500"></p>
                            <button id="handle-edit-btn" onclick="startEditing('handle')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit handle">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="handle-edit-form" class="hidden mt-1">
                            <div class="flex flex-wrap gap-2 items-center">
                                <div class="relative">
                                    <span class="absolute left-2 top-1.5 text-gray-400 text-sm">@</span>
                                    <input type="text" id="edit-handle" placeholder="handle" pattern="[a-z0-9_]+" maxlength="30" class="pl-6 pr-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-40">
                                </div>
                                <button onclick="checkHandle()" class="px-2 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Check</button>
                                <button onclick="saveHandle()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                                <button onclick="cancelEditing('handle')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                            </div>
                            <p id="handle-status" class="text-sm mt-1"></p>
                        </div>

                        <!-- Headline display/edit -->
                        <div id="headline-display" class="group flex items-center gap-2 mt-1">
                            <p id="profile-headline" class="text-gray-600"></p>
                            <button id="headline-edit-btn" onclick="startEditing('headline')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit headline">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="headline-edit-form" class="hidden mt-1">
                            <div class="flex flex-wrap gap-2 items-center">
                                <input type="text" id="edit-headline" placeholder="What do you do?" maxlength="200" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-64">
                                <button onclick="saveHeadline()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                                <button onclick="cancelEditing('headline')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                            </div>
                            <p id="headline-error" class="text-red-600 text-sm mt-1 hidden"></p>
                        </div>
                    </div>

                    <!-- Action buttons (for non-owners) -->
                    <div id="action-buttons" class="flex gap-2 flex-shrink-0">
                        <a id="message-btn" href="#" class="hidden px-4 py-2 border border-brand-blue text-brand-blue rounded-md text-sm font-medium hover:bg-blue-50">
                            Message
                        </a>
                        <button id="connect-btn" class="hidden px-4 py-2 bg-brand-blue text-white rounded-md text-sm font-medium hover:opacity-90">
                            Connect
                        </button>
                    </div>
                </div>

                <!-- Skills display/edit -->
                <div id="skills-display" class="group flex items-center gap-2 mt-4">
                    <div id="profile-skills" class="flex flex-wrap gap-2"></div>
                    <button id="skills-edit-btn" onclick="startEditing('skills')" class="hidden opacity-0 group-hover:opacity-100 touch-show p-1 text-gray-400 hover:text-gray-600 transition-opacity" title="Edit skills">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                </div>
                <div id="skills-edit-form" class="hidden mt-4">
                    <div class="flex flex-wrap gap-2 items-center">
                        <input type="text" id="edit-skills" placeholder="Python, FastAPI, Design (comma-separated)" class="px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-brand-blue w-80">
                        <button onclick="saveSkills()" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:opacity-90">Save</button>
                        <button onclick="cancelEditing('skills')" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">Cancel</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Separate skills with commas</p>
                    <p id="skills-error" class="text-red-600 text-sm mt-1 hidden"></p>
                </div>

                <!-- Connection status badge -->
                <div id="connection-status" class="hidden mt-4">
                    <span class="inline-flex items-center gap-1 text-sm text-green-700 bg-green-100 px-3 py-1 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Connected
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Facts Section -->
<div id="facts-section" class="hidden sm:mt-4 mt-2 w-full">
    <div class="bg-white sm:rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Professional Facts</h2>
                <button id="add-fact-btn" onclick="showAddFactModal()" class="hidden text-sm text-brand-blue hover:underline">
                    + Add a fact
                </button>
            </div>
        </div>
        <div id="facts-list" class="divide-y divide-gray-100">
            <!-- Facts will be loaded here -->
        </div>
        <div id="facts-empty" class="hidden px-6 py-8 text-center text-gray-500">
            No professional facts yet
        </div>
    </div>
</div>

<!-- Add Fact Modal -->
<div id="add-fact-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Add a Professional Fact</h2>
                <button onclick="hideAddFactModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Template Selection -->
            <div id="template-selection" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">What type of fact?</label>
                    <select id="fact-subject-type" onchange="updateTemplateOptions()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue">
                        <option value="">Select type...</option>
                        <option value="company">About a company</option>
                        <option value="education">About an education institution</option>
                        <option value="user">About a person</option>
                    </select>
                </div>

                <div id="template-options" class="hidden space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Choose a template</label>
                    <!-- Template buttons will be added here -->
                </div>
            </div>

            <!-- Fact Form -->
            <div id="fact-form" class="hidden space-y-4 mt-4">
                <div id="fact-template-preview" class="p-3 bg-gray-50 rounded-md text-sm text-gray-600"></div>

                <div id="subject-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                    <input type="text" id="fact-subject" placeholder="@handle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    <div id="subject-suggestions" class="hidden mt-1 border border-gray-200 rounded-md shadow-sm max-h-32 overflow-y-auto bg-white"></div>
                </div>

                <div id="from-date-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <input type="text" id="fact-from-date" placeholder="e.g., 2020" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue">
                </div>

                <div id="to-date-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <input type="text" id="fact-to-date" placeholder="e.g., 2023 or present" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue">
                </div>

                <div id="year-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                    <input type="text" id="fact-year" placeholder="e.g., 2023" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue">
                </div>

                <div id="page-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">At (company/organization)</label>
                    <input type="text" id="fact-page" placeholder="@company" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    <div id="page-suggestions" class="hidden mt-1 border border-gray-200 rounded-md shadow-sm max-h-32 overflow-y-auto bg-white"></div>
                </div>

                <div id="content-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your fact (freeform)</label>
                    <textarea id="fact-content" rows="3" placeholder="Write your professional fact..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-blue"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Freeform facts are less trusted. Use templates when possible.</p>
                </div>

                <div id="fact-error" class="hidden text-red-600 text-sm"></div>

                <div class="flex gap-3 pt-2">
                    <button onclick="hideAddFactModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                    <button onclick="submitFact()" class="flex-1 px-4 py-2 bg-brand-blue text-white rounded-md hover:opacity-90">Add Fact</button>
                </div>

                <p class="text-xs text-gray-500 text-center">
                    Facts have a 72-hour cooldown before going public. The subject can veto at any time.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Pending Request Modal (for incoming requests) -->
<div id="pending-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Connection Request</h2>
                <button onclick="hidePendingModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-gray-600 mb-4"><span id="pending-name" class="font-medium"></span> wants to connect with you.</p>
            <div id="pending-error" class="hidden text-red-600 text-sm mb-4"></div>
            <div class="flex gap-3">
                <button onclick="ignorePendingRequest()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Ignore</button>
                <button onclick="confirmPendingRequest()" class="flex-1 px-4 py-2 bg-brand-blue text-white rounded-md hover:opacity-90">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/posts.js"></script>
<script>
    const handle = '{{ handle }}';
    let profileData = null;
    let ownerData = null;
    let isOwner = false;
    let profileName = '';
    let connectionStatus = null;
    let handleAvailable = null;
    let editingSection = null;

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(window.atob(base64));
        } catch (e) {
            return null;
        }
    }

    async function checkOwnership() {
        const token = localStorage.getItem('token');
        if (!token) return false;

        const payload = parseJwt(token);
        if (!payload || payload.exp * 1000 <= Date.now()) return false;

        try {
            const res = await fetch('/api/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                ownerData = await res.json();
                isOwner = ownerData.handle === handle;
                return isOwner;
            }
        } catch (e) {}
        return false;
    }

    function showOwnerControls() {
        // Show edit overlays
        document.getElementById('cover-edit-overlay').classList.remove('hidden');
        document.getElementById('avatar-edit-overlay').classList.remove('hidden');

        // Show edit buttons
        document.getElementById('name-edit-btn').classList.remove('hidden');
        document.getElementById('handle-edit-btn').classList.remove('hidden');
        document.getElementById('headline-edit-btn').classList.remove('hidden');
        document.getElementById('skills-edit-btn').classList.remove('hidden');

        // Show delete buttons if images exist
        if (profileData.cover_url) {
            document.getElementById('cover-delete-btn').classList.remove('hidden');
        }
        if (profileData.avatar_url) {
            document.getElementById('avatar-delete-btn').classList.remove('hidden');
        }

        // Hide connection buttons for own profile
        document.getElementById('action-buttons').classList.add('hidden');
    }

    async function loadPublicProfile() {
        try {
            const response = await fetch(`/api/u/${encodeURIComponent(handle)}`);

            if (response.status === 404) {
                document.querySelector('.mt-2').innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center">
                        <h1 class="text-2xl font-bold text-gray-900 mb-2">User not found</h1>
                        <p class="text-gray-600">The profile you're looking for doesn't exist.</p>
                    </div>
                `;
                return;
            }

            profileData = await response.json();
            profileName = profileData.name || handle;

            document.getElementById('profile-name').textContent = profileName;
            document.getElementById('profile-handle').textContent = '@' + handle;
            document.getElementById('profile-headline').textContent = profileData.headline || '';
            document.getElementById('pending-name').textContent = profileName;

            if (profileData.avatar_url) {
                document.getElementById('avatar-image').src = profileData.avatar_url;
            }

            if (profileData.cover_url) {
                document.getElementById('cover-image').style.backgroundImage = `url(${profileData.cover_url})`;
            }

            const skillsContainer = document.getElementById('profile-skills');
            if (profileData.skills && profileData.skills.length > 0) {
                skillsContainer.innerHTML = profileData.skills.map(skill =>
                    `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${escapeHtml(skill)}</span>`
                ).join('');
            } else {
                skillsContainer.innerHTML = '<span class="text-gray-400 text-sm">No skills added</span>';
            }

            if (profileData.name) {
                document.title = `${profileData.name} | JustPros`;
            }

            // Check ownership and show controls
            await checkOwnership();
            if (isOwner) {
                showOwnerControls();
            } else {
                await updateButtons();
            }
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- Inline Editing ---

    function startEditing(section) {
        if (editingSection && editingSection !== section) {
            cancelEditing(editingSection);
        }
        editingSection = section;

        document.getElementById(`${section}-display`).classList.add('hidden');
        document.getElementById(`${section}-edit-form`).classList.remove('hidden');

        // Pre-fill values
        if (section === 'name') {
            // Need to get first/middle/last from ownerData
            document.getElementById('edit-first-name').value = ownerData.first_name || '';
            document.getElementById('edit-middle-name').value = ownerData.middle_name || '';
            document.getElementById('edit-last-name').value = ownerData.last_name || '';
            document.getElementById('edit-first-name').focus();
        } else if (section === 'handle') {
            document.getElementById('edit-handle').value = handle;
            document.getElementById('edit-handle').dataset.original = handle;
            document.getElementById('handle-status').textContent = '';
            handleAvailable = true;
            document.getElementById('edit-handle').focus();
        } else if (section === 'headline') {
            document.getElementById('edit-headline').value = profileData.headline || '';
            document.getElementById('edit-headline').focus();
        } else if (section === 'skills') {
            document.getElementById('edit-skills').value = (profileData.skills || []).join(', ');
            document.getElementById('edit-skills').focus();
        }
    }

    function cancelEditing(section) {
        document.getElementById(`${section}-display`).classList.remove('hidden');
        document.getElementById(`${section}-edit-form`).classList.add('hidden');
        // Hide any error messages
        const errorEl = document.getElementById(`${section}-error`);
        if (errorEl) errorEl.classList.add('hidden');
        editingSection = null;
    }

    async function saveName() {
        const token = localStorage.getItem('token');
        const firstName = document.getElementById('edit-first-name').value.trim();
        const middleName = document.getElementById('edit-middle-name').value.trim();
        const lastName = document.getElementById('edit-last-name').value.trim();
        const errorEl = document.getElementById('name-error');

        try {
            const response = await fetch('/api/me', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    first_name: firstName || null,
                    middle_name: middleName || null,
                    last_name: lastName || null
                })
            });

            if (response.ok) {
                // Update local data and display
                ownerData.first_name = firstName;
                ownerData.middle_name = middleName;
                ownerData.last_name = lastName;
                const fullName = [firstName, middleName, lastName].filter(Boolean).join(' ');
                profileData.name = fullName;
                document.getElementById('profile-name').textContent = fullName || handle;
                cancelEditing('name');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    async function checkHandle() {
        const token = localStorage.getItem('token');
        const newHandle = document.getElementById('edit-handle').value.toLowerCase();
        const original = document.getElementById('edit-handle').dataset.original;
        const statusEl = document.getElementById('handle-status');

        if (!newHandle) {
            statusEl.textContent = '';
            handleAvailable = null;
            return;
        }

        if (!/^[a-z0-9_]+$/.test(newHandle)) {
            statusEl.textContent = 'Only lowercase letters, numbers, and underscores allowed';
            statusEl.className = 'text-sm mt-1 text-red-600';
            handleAvailable = false;
            return;
        }

        if (newHandle.length < 3) {
            statusEl.textContent = 'Handle must be at least 3 characters';
            statusEl.className = 'text-sm mt-1 text-red-600';
            handleAvailable = false;
            return;
        }

        if (newHandle === original) {
            statusEl.textContent = 'This is your current handle';
            statusEl.className = 'text-sm mt-1 text-gray-500';
            handleAvailable = true;
            return;
        }

        statusEl.textContent = 'Checking...';
        statusEl.className = 'text-sm mt-1 text-gray-500';

        try {
            const response = await fetch(`/api/handle/check?handle=${encodeURIComponent(newHandle)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.status === 429) {
                statusEl.textContent = 'Too many checks. Please wait.';
                statusEl.className = 'text-sm mt-1 text-red-600';
                handleAvailable = null;
                return;
            }

            const data = await response.json();
            if (data.available) {
                statusEl.textContent = 'Available!';
                statusEl.className = 'text-sm mt-1 text-green-600';
                handleAvailable = true;
            } else {
                statusEl.textContent = 'Already taken';
                statusEl.className = 'text-sm mt-1 text-red-600';
                handleAvailable = false;
            }
        } catch (error) {
            statusEl.textContent = 'Error checking handle';
            statusEl.className = 'text-sm mt-1 text-red-600';
            handleAvailable = null;
        }
    }

    async function saveHandle() {
        const token = localStorage.getItem('token');
        const newHandle = document.getElementById('edit-handle').value.toLowerCase();
        const statusEl = document.getElementById('handle-status');

        if (handleAvailable === false) {
            statusEl.textContent = 'Please choose an available handle';
            statusEl.className = 'text-sm mt-1 text-red-600';
            return;
        }

        try {
            const response = await fetch('/api/me', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ handle: newHandle })
            });

            if (response.ok) {
                // Redirect to new handle URL
                window.location.href = `/u/${newHandle}`;
            } else {
                const data = await response.json();
                statusEl.textContent = data.detail || 'Failed to save';
                statusEl.className = 'text-sm mt-1 text-red-600';
            }
        } catch (e) {
            statusEl.textContent = 'Failed to save';
            statusEl.className = 'text-sm mt-1 text-red-600';
        }
    }

    async function saveHeadline() {
        const token = localStorage.getItem('token');
        const headline = document.getElementById('edit-headline').value.trim();
        const errorEl = document.getElementById('headline-error');

        try {
            const response = await fetch('/api/me', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ headline: headline || null })
            });

            if (response.ok) {
                profileData.headline = headline;
                document.getElementById('profile-headline').textContent = headline;
                cancelEditing('headline');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    async function saveSkills() {
        const token = localStorage.getItem('token');
        const skillsInput = document.getElementById('edit-skills').value;
        const skills = skillsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
        const errorEl = document.getElementById('skills-error');

        try {
            const response = await fetch('/api/me', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ skills })
            });

            if (response.ok) {
                profileData.skills = skills;
                const skillsContainer = document.getElementById('profile-skills');
                if (skills.length > 0) {
                    skillsContainer.innerHTML = skills.map(skill =>
                        `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${escapeHtml(skill)}</span>`
                    ).join('');
                } else {
                    skillsContainer.innerHTML = '<span class="text-gray-400 text-sm">No skills added</span>';
                }
                cancelEditing('skills');
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to save';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to save';
            errorEl.classList.remove('hidden');
        }
    }

    // --- Image Upload ---

    document.getElementById('cover-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            document.getElementById('cover-message').innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">File too large (max 5MB)</span>';
            return;
        }

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('cover-message');
        messageEl.innerHTML = '<span class="text-white bg-black bg-opacity-50 px-2 py-1 rounded">Uploading...</span>';

        try {
            const urlRes = await fetch('/api/me/cover/upload-url', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_type: file.type })
            });

            if (!urlRes.ok) {
                const data = await urlRes.json();
                messageEl.innerHTML = `<span class="text-red-600 bg-white px-2 py-1 rounded">${data.detail || 'Failed'}</span>`;
                return;
            }

            const { upload_url, media_path } = await urlRes.json();

            const uploadRes = await fetch(upload_url, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });

            if (!uploadRes.ok) {
                messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Upload failed</span>';
                return;
            }

            const confirmRes = await fetch('/api/me/cover/confirm', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ media_path })
            });

            if (confirmRes.ok) {
                const data = await confirmRes.json();
                document.getElementById('cover-image').style.backgroundImage = `url(${data.cover_url})`;
                profileData.cover_url = data.cover_url;
                document.getElementById('cover-delete-btn').classList.remove('hidden');
                messageEl.innerHTML = '<span class="text-green-600 bg-white px-2 py-1 rounded">Updated!</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
        }
        e.target.value = '';
    });

    document.getElementById('avatar-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 2 * 1024 * 1024) {
            document.getElementById('avatar-message').innerHTML = '<span class="text-red-600">Too large (max 2MB)</span>';
            return;
        }

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('avatar-message');
        messageEl.innerHTML = '<span class="text-gray-500">Uploading...</span>';

        try {
            const urlRes = await fetch('/api/me/avatar/upload-url', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_type: file.type })
            });

            if (!urlRes.ok) {
                const data = await urlRes.json();
                messageEl.innerHTML = `<span class="text-red-600">${data.detail || 'Failed'}</span>`;
                return;
            }

            const { upload_url, media_path } = await urlRes.json();

            const uploadRes = await fetch(upload_url, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });

            if (!uploadRes.ok) {
                messageEl.innerHTML = '<span class="text-red-600">Upload failed</span>';
                return;
            }

            const confirmRes = await fetch('/api/me/avatar/confirm', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ media_path })
            });

            if (confirmRes.ok) {
                const data = await confirmRes.json();
                document.getElementById('avatar-image').src = data.avatar_url;
                profileData.avatar_url = data.avatar_url;
                document.getElementById('avatar-delete-btn').classList.remove('hidden');
                messageEl.innerHTML = '<span class="text-green-600">Updated!</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
        }
        e.target.value = '';
    });

    async function deleteCover() {
        if (!confirm('Delete your cover image?')) return;

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('cover-message');

        try {
            const response = await fetch('/api/me/cover', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                document.getElementById('cover-image').style.backgroundImage = '';
                document.getElementById('cover-delete-btn').classList.add('hidden');
                profileData.cover_url = null;
                messageEl.innerHTML = '<span class="text-green-600 bg-white px-2 py-1 rounded">Deleted</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600 bg-white px-2 py-1 rounded">Failed</span>';
        }
    }

    async function deleteAvatar() {
        if (!confirm('Delete your profile photo?')) return;

        const token = localStorage.getItem('token');
        const messageEl = document.getElementById('avatar-message');

        try {
            const response = await fetch('/api/me/avatar', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                document.getElementById('avatar-image').src = '/static/default-avatar.svg';
                document.getElementById('avatar-delete-btn').classList.add('hidden');
                profileData.avatar_url = null;
                messageEl.innerHTML = '<span class="text-green-600">Deleted</span>';
                setTimeout(() => messageEl.innerHTML = '', 2000);
            } else {
                messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
            }
        } catch (error) {
            messageEl.innerHTML = '<span class="text-red-600">Failed</span>';
        }
    }

    // --- Connection Buttons (for non-owners) ---

    async function updateButtons() {
        const token = localStorage.getItem('token');
        if (!token) return;

        const payload = parseJwt(token);
        if (!payload || payload.exp * 1000 <= Date.now()) return;

        try {
            const response = await fetch(`/api/people/status/${encodeURIComponent(handle)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;

            connectionStatus = await response.json();

            const connectBtn = document.getElementById('connect-btn');
            const messageBtn = document.getElementById('message-btn');
            const statusBadge = document.getElementById('connection-status');

            if (connectionStatus.is_connected) {
                messageBtn.href = `/messages/${handle}`;
                messageBtn.classList.remove('hidden');
                statusBadge.classList.remove('hidden');
                connectBtn.classList.add('hidden');
            } else if (connectionStatus.pending_from_them) {
                connectBtn.textContent = 'Respond';
                connectBtn.onclick = showPendingModal;
                connectBtn.classList.remove('hidden');
            } else if (connectionStatus.pending_from_me) {
                connectBtn.textContent = 'Pending...';
                connectBtn.disabled = true;
                connectBtn.className = 'px-4 py-2 bg-gray-100 text-gray-500 rounded-md text-sm font-medium cursor-not-allowed';
                connectBtn.classList.remove('hidden');
            } else {
                connectBtn.textContent = 'Connect';
                connectBtn.onclick = sendConnectionRequest;
                connectBtn.classList.remove('hidden');
            }
        } catch (e) {
            console.error('Failed to check connection status:', e);
        }
    }

    // --- Connection Actions ---

    async function sendConnectionRequest() {
        const token = localStorage.getItem('token');
        const connectBtn = document.getElementById('connect-btn');
        const originalText = connectBtn.textContent;

        connectBtn.disabled = true;
        connectBtn.textContent = 'Sending...';

        try {
            const response = await fetch(`/api/people/${encodeURIComponent(handle)}/connect`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to send connection request');
            }

            // Update button to show pending state
            connectBtn.textContent = 'Pending...';
            connectBtn.className = 'px-4 py-2 bg-gray-100 text-gray-500 rounded-md text-sm font-medium cursor-not-allowed';
        } catch (e) {
            alert(e.message);
            connectBtn.disabled = false;
            connectBtn.textContent = originalText;
        }
    }

    function showPendingModal() {
        document.getElementById('pending-modal').classList.remove('hidden');
    }

    function hidePendingModal() {
        document.getElementById('pending-modal').classList.add('hidden');
        document.getElementById('pending-error').classList.add('hidden');
    }

    async function confirmPendingRequest() {
        const token = localStorage.getItem('token');
        const errorEl = document.getElementById('pending-error');

        try {
            const response = await fetch(`/api/people/${encodeURIComponent(handle)}/confirm`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to confirm connection');
            }

            hidePendingModal();
            await updateButtons();
        } catch (e) {
            errorEl.textContent = e.message;
            errorEl.classList.remove('hidden');
        }
    }

    async function ignorePendingRequest() {
        const token = localStorage.getItem('token');
        const errorEl = document.getElementById('pending-error');

        try {
            const response = await fetch(`/api/people/${encodeURIComponent(handle)}/ignore`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to ignore request');
            }

            hidePendingModal();
            await updateButtons();
        } catch (e) {
            errorEl.textContent = e.message;
            errorEl.classList.remove('hidden');
        }
    }

    // Close modals/editing on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hidePendingModal();
            if (editingSection) {
                cancelEditing(editingSection);
            }
        }
    });

    document.getElementById('pending-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) hidePendingModal();
    });

    // --- Facts System ---

    let factsData = [];
    let factTemplates = [];
    let selectedTemplate = null;
    let selectedSubjectType = null;

    function linkifyMentions(content, mentions) {
        if (!mentions || typeof mentions !== 'object') {
            return escapeHtml(content);
        }

        // Escape content first, then replace names with links
        let result = escapeHtml(content);

        for (const [handle, info] of Object.entries(mentions)) {
            const escapedHandle = escapeHtml(handle);
            const escapedName = escapeHtml(info.name || handle);
            const prefix = info.type === 'page' ? '/p/' : '/u/';
            const link = `<a href="${prefix}${escapedHandle}" class="text-brand-blue hover:underline">${escapedName}</a>`;
            // Replace the name with a link
            result = result.replace(escapedName, link);
        }

        return result;
    }

    async function loadFacts() {
        try {
            const token = localStorage.getItem('token');
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

            const response = await fetch(`/api/facts/user/${encodeURIComponent(handle)}`, { headers });
            if (!response.ok) return;

            factsData = await response.json();

            const factsSection = document.getElementById('facts-section');
            const factsList = document.getElementById('facts-list');
            const factsEmpty = document.getElementById('facts-empty');

            // Show section if owner or has facts
            if (isOwner || factsData.length > 0) {
                factsSection.classList.remove('hidden');
            }

            // Show add button for owner
            if (isOwner) {
                document.getElementById('add-fact-btn').classList.remove('hidden');
            }

            if (factsData.length === 0) {
                factsEmpty.classList.remove('hidden');
                factsList.innerHTML = '';
            } else {
                factsEmpty.classList.add('hidden');
                factsList.innerHTML = factsData.map(fact => renderFact(fact)).join('');
            }
        } catch (e) {
            console.error('Failed to load facts:', e);
        }
    }

    function renderFact(fact) {
        const upvotes = fact.upvote_count || 0;
        const downvotes = fact.downvote_count || 0;
        const token = localStorage.getItem('token');
        const canVote = token && fact.is_public && !fact.is_vetoed && !isOwner;

        // Status badge
        let statusBadge = '';
        if (fact.is_vetoed) {
            statusBadge = '<span class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded-full">Vetoed</span>';
        } else if (!fact.is_public) {
            statusBadge = '<span class="text-xs px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full">Pending</span>';
        }

        // Delete/veto button for owner
        const deleteBtn = isOwner ? `
            <button onclick="deleteFact(${fact.id})" class="text-gray-400 hover:text-red-500" title="Delete fact">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </button>
        ` : '';

        return `
            <div class="px-6 py-4 flex items-start gap-4" data-fact-id="${fact.id}">
                <div class="flex-1 min-w-0">
                    <p class="text-gray-900">${linkifyMentions(fact.content, fact.mentions)}</p>
                    <div class="flex items-center gap-2 mt-2">
                        ${statusBadge}
                        <span class="text-xs text-gray-500">${formatFactTime(fact.created_at)}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    ${renderVoteButtons(fact.id, upvotes, downvotes, fact.user_vote, canVote, 'fact')}
                    ${deleteBtn}
                </div>
            </div>
        `;
    }

    function formatFactTime(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    async function deleteFact(factId) {
        if (!confirm('Delete this fact?')) return;

        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/api/facts/${factId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                await loadFacts();
            } else {
                const data = await response.json();
                alert(data.detail || 'Failed to delete');
            }
        } catch (e) {
            alert('Failed to delete fact');
        }
    }

    async function submitFactVote(factId, value, event) {
        event.stopPropagation();
        const token = localStorage.getItem('token');

        if (value === null) {
            // Remove vote
            try {
                const response = await fetch(`/api/facts/${factId}/vote`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    await loadFacts();
                }
            } catch (e) {
                console.error('Failed to remove vote:', e);
            }
        } else {
            // Submit vote
            try {
                const response = await fetch(`/api/facts/${factId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value })
                });

                if (response.ok) {
                    await loadFacts();
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to vote');
                }
            } catch (e) {
                alert('Failed to vote');
            }
        }
    }

    // --- Add Fact Modal ---

    function showAddFactModal() {
        document.getElementById('add-fact-modal').classList.remove('hidden');
        resetFactForm();
        loadTemplates();
    }

    function hideAddFactModal() {
        document.getElementById('add-fact-modal').classList.add('hidden');
        resetFactForm();
    }

    function resetFactForm() {
        document.getElementById('fact-subject-type').value = '';
        document.getElementById('template-options').classList.add('hidden');
        document.getElementById('fact-form').classList.add('hidden');
        document.getElementById('fact-error').classList.add('hidden');
        document.getElementById('fact-subject').value = '';
        document.getElementById('fact-from-date').value = '';
        document.getElementById('fact-to-date').value = '';
        document.getElementById('fact-year').value = '';
        document.getElementById('fact-page').value = '';
        document.getElementById('fact-content').value = '';
        selectedTemplate = null;
        selectedSubjectType = null;
    }

    async function loadTemplates() {
        try {
            const response = await fetch('/api/facts/templates');
            if (response.ok) {
                factTemplates = await response.json();
            }
        } catch (e) {
            console.error('Failed to load templates:', e);
        }
    }

    function updateTemplateOptions() {
        const subjectType = document.getElementById('fact-subject-type').value;
        selectedSubjectType = subjectType;

        const container = document.getElementById('template-options');
        if (!subjectType) {
            container.classList.add('hidden');
            return;
        }

        const filtered = factTemplates.filter(t => t.subject_types.includes(subjectType));
        container.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-2">Choose a template</label>
            ${filtered.map(t => `
                <button type="button" onclick="selectTemplate('${t.id}')"
                    class="w-full text-left px-3 py-2 border rounded-md hover:bg-gray-50 ${t.id === 'freeform' ? 'text-gray-500 border-dashed' : ''}">
                    ${escapeHtml(t.label)}
                    <span class="block text-xs text-gray-400 mt-0.5">${escapeHtml(t.format)}</span>
                </button>
            `).join('')}
        `;
        container.classList.remove('hidden');
    }

    function selectTemplate(templateId) {
        selectedTemplate = factTemplates.find(t => t.id === templateId);
        if (!selectedTemplate) return;

        document.getElementById('fact-template-preview').textContent = selectedTemplate.format;

        // Show/hide fields based on template
        const fields = selectedTemplate.fields || [];
        document.getElementById('from-date-field').classList.toggle('hidden', !fields.includes('from_date'));
        document.getElementById('to-date-field').classList.toggle('hidden', !fields.includes('to_date'));
        document.getElementById('year-field').classList.toggle('hidden', !fields.includes('year'));
        document.getElementById('page-field').classList.toggle('hidden', !fields.includes('page'));
        document.getElementById('content-field').classList.toggle('hidden', templateId !== 'freeform');
        document.getElementById('subject-field').classList.toggle('hidden', templateId === 'freeform');

        document.getElementById('fact-form').classList.remove('hidden');
    }

    // --- Autocomplete for handle fields ---

    let autocompleteTimeout = null;

    function debounce(fn, delay) {
        return function(...args) {
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    async function searchHandles(query, filterType) {
        const token = localStorage.getItem('token');
        if (!token || query.length < 2) return [];

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return [];

            const results = await response.json();

            // Filter by type if specified
            if (filterType === 'user') {
                return results.filter(r => r.type === 'user');
            } else if (filterType === 'page') {
                return results.filter(r => r.type === 'page');
            } else if (filterType === null && selectedSubjectType) {
                // Filter based on selected subject type
                if (selectedSubjectType === 'user') {
                    return results.filter(r => r.type === 'user');
                } else {
                    // For company, education, etc. - filter pages by kind
                    return results.filter(r => r.type === 'page' && r.kind === selectedSubjectType);
                }
            }
            return results;
        } catch (e) {
            return [];
        }
    }

    function renderSuggestions(results, container, inputId) {
        if (results.length === 0) {
            container.classList.add('hidden');
            return;
        }

        container.innerHTML = results.map(r => {
            const avatarUrl = r.avatar_url || r.icon_url || (r.type === 'user' ? '/static/default-avatar.svg' : '/static/default-page.svg');
            const displayName = escapeHtml(r.name || r.handle);
            const subtitle = r.type === 'page' ? escapeHtml(r.kind || '') : escapeHtml(r.headline || '');

            return `
                <div class="flex items-center gap-2 px-3 py-2 hover:bg-gray-100 cursor-pointer"
                     onclick="selectSuggestion('${inputId}', '${escapeHtml(r.handle)}', '${escapeHtml(r.name || r.handle)}')">
                    <img src="${avatarUrl}" alt="" class="w-8 h-8 rounded-full object-cover bg-gray-200 flex-shrink-0">
                    <div class="min-w-0 flex-1">
                        <div class="text-sm font-medium text-gray-900 truncate">${displayName}</div>
                        <div class="text-xs text-gray-500 truncate">@${escapeHtml(r.handle)}${subtitle ? '  ' + subtitle : ''}</div>
                    </div>
                </div>
            `;
        }).join('');

        container.classList.remove('hidden');
    }

    function selectSuggestion(inputId, handle, name) {
        const input = document.getElementById(inputId);
        input.value = '@' + handle;
        input.dataset.selectedHandle = handle;
        input.dataset.selectedName = name;

        // Hide suggestions
        const suggestionsId = inputId === 'fact-subject' ? 'subject-suggestions' : 'page-suggestions';
        document.getElementById(suggestionsId).classList.add('hidden');
    }

    function setupAutocomplete(inputId, suggestionsId, filterType) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);

        const doSearch = debounce(async (query) => {
            // Remove @ prefix for search
            const searchQuery = query.replace(/^@/, '');
            if (searchQuery.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }

            const results = await searchHandles(searchQuery, filterType);
            renderSuggestions(results, suggestions, inputId);
        }, 300);

        input.addEventListener('input', (e) => {
            doSearch(e.target.value);
        });

        input.addEventListener('focus', (e) => {
            const val = e.target.value.replace(/^@/, '');
            if (val.length >= 2) {
                doSearch(e.target.value);
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });
    }

    // Initialize autocomplete for both fields
    setupAutocomplete('fact-subject', 'subject-suggestions', null); // null = search both users and pages based on selectedSubjectType
    setupAutocomplete('fact-page', 'page-suggestions', 'page'); // always search pages

    async function submitFact() {
        const token = localStorage.getItem('token');
        const errorEl = document.getElementById('fact-error');
        errorEl.classList.add('hidden');

        if (!selectedTemplate) {
            errorEl.textContent = 'Please select a template';
            errorEl.classList.remove('hidden');
            return;
        }

        const payload = {
            template_id: selectedTemplate.id
        };

        // Get subject
        const subjectValue = document.getElementById('fact-subject').value.replace('@', '').trim();
        if (selectedSubjectType === 'user') {
            payload.subject_user_handle = subjectValue;
        } else if (selectedSubjectType && selectedTemplate.id !== 'freeform') {
            payload.subject_page_handle = subjectValue;
        }

        // Get optional fields
        if (selectedTemplate.fields.includes('from_date')) {
            payload.from_date = document.getElementById('fact-from-date').value.trim();
        }
        if (selectedTemplate.fields.includes('to_date')) {
            payload.to_date = document.getElementById('fact-to-date').value.trim();
        }
        if (selectedTemplate.fields.includes('year')) {
            payload.year = document.getElementById('fact-year').value.trim();
        }
        if (selectedTemplate.fields.includes('page')) {
            payload.page_handle = document.getElementById('fact-page').value.replace('@', '').trim();
        }
        if (selectedTemplate.id === 'freeform') {
            payload.content = document.getElementById('fact-content').value.trim();
        }

        try {
            const response = await fetch('/api/facts', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                hideAddFactModal();
                await loadFacts();
            } else {
                const data = await response.json();
                errorEl.textContent = data.detail || 'Failed to create fact';
                errorEl.classList.remove('hidden');
            }
        } catch (e) {
            errorEl.textContent = 'Failed to create fact';
            errorEl.classList.remove('hidden');
        }
    }

    document.getElementById('add-fact-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) hideAddFactModal();
    });

    // Update escape key handler
    const originalKeydown = document.onkeydown;
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideAddFactModal();
        }
    });

    // Load facts after profile
    const originalLoadProfile = loadPublicProfile;
    async function loadPublicProfileWithFacts() {
        await originalLoadProfile();
        await loadFacts();
    }

    loadPublicProfileWithFacts();
</script>
{% endblock %}
